### 2장 개략적인 규모 추정

- 시스템 용량이나 성능 요구사항을 개략적으로 추정해 보라는 요구를 받게 될 수 있다. 어떤 설계가 요구사항에 부합할 것인지 보기 위한 것이다.
- 규모 확장성을 표현하는데 필요한 기본기에 능숙해야 한다. 특히, 2의 제곱수나 응답지연(latency) 값, 가용성에 관련된 수치들을 기본적으로 잘 이해하고 있어야 한다.
- 2의 제곱수
    - 최소 단위는 1바이트이고, 8비트로 구성된다.
    - ASCII 문자 하나가 차지하는 메모리 크기가 1바이트이다.
        
        
        | 2의 x 제곱 | 근사치 | 이름 | 축약형 |
        | --- | --- | --- | --- |
        | 10 | 1천(thousand) | 1 Kilobyte | 1KB |
        | 20 | 1백만(million) | 1 Megabyte | 1MB |
        | 30 | 10억(billion) | 1 Gigabyte | 1GB |
        | 40 | 1조(trillion) | 1 Terabyte | 1TB |
        | 50 | 1000조(quadrillion) | 1 Petabyte | 1PB |
    
- 응답지연(latency) 값
    
    
    | 연산명 | 시간 |
    | --- | --- |
    | L1 캐시 참조 | 0.5ns |
    | 분기 예측 오류(branch mispredict) | 5ns |
    | L2 캐시 참조 | 7ns |
    | 뮤텍스 락/언락 | 100ns |
    | 주 메모리 참조 | 100ns |
    | Zippy로 1KB 압축 | 10,000ns = 10us |
    | 1 Gbps 네트워크로 2 KB 전송 | 20,000ns = 20us |
    | 메모리에서 1MB 순차적으로 read | 250,000ns = 250us |
    | 같은 데이터 센터 내에서의 메시지 왕복 지연시간 | 500,000ns = 500us |
    | 디스크 탐색(seek) | 10,000,000ns = 10ms |
    | 네트워크에서 1 MB 순차적으로 read | 10,000,000ns = 10ms |
    | 디스크에서 1 MB 순차적으로 read | 30,000,000ns = 30ms |
    | 한 패킷의 CA(캘리포니아)로부터 네덜란드까지의 왕복 지연시간 | 150,000,000ns = 150ms |
    - 단위
        - ns = nanosecond(나노초)
        - us = microsecond(마이크로초)
        - ms = milisecond(밀리초)
        - 1나노초 = 10^(-9)초, 1마이크로초 = 10^(-6)초 = 1,000나노초
        - 1밀리초 = 10^(-3)초 = 1,000us = 1,000,000ns
        - 일반 상용 네트워크상에서 2K바이트 전송 : 44ns
    - 그 외 예시들
        - SSD상에서 임의 위치의 데이터 읽기 : 16,000ns ~= 16us
        - 메모리에서 1M바이트 순차적 읽기 : 3,000ns ~= 3us
        - 동일 데이터 센터 내에서의 패킷 왕복 지연시간 : 500,000ns ~= 500us
        - 1,000,000ns ~= 1ms
        - SSD에서 1M바이트 순차적 읽기: 49,000ns ~= 49us
        - 디스크 탐색 : 2,000,000ns ~= 2ms
        - 디스크에서 1M바이트 순차적 읽기 : 825,000ns ~= 825us
        - CA에서 네덜란드까지의 패킷 왕복 지연시간: 150,000,000ns ~= 150ms
    - 위에 제시된 수치들을 분석하면 다음과 같은 결론이 나옴
        - 메모리는 빠르지만 디스크는 아직도 느리다.
        - 디스크 탐색(seek)는 가능한 피하라
        - 단순한 압축 알고리즘은 빠르다.
        - 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라.
        - 데이터 센터는 보통 여러 지역에(region)에 분산되어 있고, 센터들 간에 데이터를 주고 받는 데에는 시간이 걸린다.
- 가용성(availability)
    - 고가용성(high availability)은 시스템이 오랜 시간 동안 지속적으로 중단 없이 운영될 수 있는 능력을 지칭하는 용어다. 고가용성을 표현하는 값은 퍼센트(percent)로 표현하는데, 100%는 시스템이 단 한 번도 중단된 적이 없었음을 의미한다. 대부분의 서비스는 99%에서 100% 사이 값을 갖음
    - SLA(Service Level Agreement)는 서비스 사업자(service provider)가 보편적으로 사용하는 용어로, 서비스 사업자와 고객 사이에 맺어진 합의를 의미한다.
    - 이 합의에는 서비스 사업자가 제공하는 서비스의 가용시간(uptime)이 공식적으로 기술되어 있다.
    - 아마존, 구글, 마이크로소프트 같은 사업자는 99% 이상의 SLA를 제공한다.
    - 가용시간은 관습적으로 9를 사용해 표시한다. 9가 많으면 많을수록 좋다고 보면 된다.
    - 9의 개수와 시스템 장애시간(downtime) 사이의 관계
        
        
        | 가용률 | 하루당 장애시간 | 주당 장애시간 | 개월당 장애시간 | 연간 장애시간 |
        | --- | --- | --- | --- | --- |
        | 99% | 14.40분 | 1.68시간 | 7.31시간 | 3.65일 |
        | 99.9% | 1.44분 | 10.08분 | 43.83분 | 8.77시간 |
        | 99.99% | 8.64초 | 1.01분 | 4.83분 | 52.60분 |
        | 99.999% | 864.00밀리초 | 6.05초 | 26.30초 | 5.26분 |
        | 99.9999% | 86.40밀리초 | 604.90밀리초 | 2.63초 | 31.56초 |
        
- 예제 : 트위터 QPS와 저장소 요구량 추정
    - 다음 제시된 수치들은 연습용이며 트위터의 실제 성능이나 요구사항과는 아무 관계가 없다.
    
    가정
    
    - 월간 능동 사용자(monthly active user)는 3억(300million) 명이다.
    - 50%의 사용자가 트위터를 매일 사용한다.
    - 평균적으로 각 사용자는 매일 2건의 트윗을 올린다.
    - 미디어를 포함하는 트윗은 10% 정도이다.
    - 데이터는 5년간 보관된다.
    
    추정
    
    QPS(Query Per Second) 추정치
    
    - 일간 능동 사용자(Daily Active User, DAU) = 3억 * 50% = 1.5억(150million)
    - QPS = 1.5억 * 2 트윗 / 24시간 / 3600초 = 약 3500
    - 최대 QPS(Peek QPS) = 2 * QPS = 약 7000
    
    미디어 저장을 위한 저장소 요구량
    
    - 평균 트윗 크기
        - tweet_id에 64바이트
        - 텍스트에 140바이트
        - 미디어에 1MB
    - 미디어 저장소 요구량: 1.5억 * 2 * 10% * 1MB = 30TB/일
    - 5년간 미디어를 보관하기 위한 저장소 요구량: 30TB * 365 * 5 = 약 55PB
- Tip
    
    개략적인 규모 추정과 관계된 면접에서 가장 중요한 것은 문제를 풀어나가는 절차다. 올바른 절차를 밟느냐가 결과를 내는 것보다 중요하다. 면접자가 보고 싶어하는 것은 여러분의 문제 해결 능력이다. 이에 도움될 몇 가지 팁을 공유하니 참고 바란다.
    
    - 근사치를 활용한 계산(rounding and approximation): 면접장에서 복잡한 계산을 하는 것은 어려운 일이다. 예를 들어, “99987/9.1”의 계산 결과는 무엇인가? 그런데 이런 데 시간을 쓰는 것은 시간 낭비다. 계산 결과의 정확함을 평가하는 것이 목적이 아니라서다. 그러니 **적절한 근사치를 활용해 시간을 절약하자.** 방금 살펴본 수식은 “100,000/10”로 간소화할 수 있다.
    - 가정(assumption)들을 적어 두라. 나중에 살펴볼 수 있도록.
    - 단위(unit)를 붙이라. 5라고만 적으면 5KB인지, 5MB인지 알 수가 없다. 나중에는 여러분 스스로도 헷갈리게 될 것이다. 단위를 붙이는 습관을 들여두면 모호함을 방지할 수 있다.
- **많이 출제되는 개략적 규모 추정 문제는 QPS, 최대 QPS, 저장소 요구량, 캐시 요구량, 서버 수 등을 추정하는 것이다**. 면접에 임하기 전에 이런 값들을 계산하는 **연습을 미리 하도록 하자.**